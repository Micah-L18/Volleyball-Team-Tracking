<div class="statistics-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <h2>Statistics Dashboard</h2>
    <div class="header-actions">
      <button (click)="openAddForm()" class="btn btn-primary">
        📊 Add Single Stat
      </button>
      <button (click)="openBulkAddForm()" class="btn btn-success">
        📈 Add Multiple Stats
      </button>
      <button (click)="openImportForm()" class="btn btn-info">
        📥 Import Data
      </button>
      <button (click)="exportStatistics()" class="btn btn-secondary">
        📤 Export CSV
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading statistics...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="dashboard-content">
    
    <!-- Main Tabs Navigation -->
    <div class="main-tabs">
      <button
        (click)="activeTab = 'team'; loadTeamStatistics()"
        [class]="'main-tab' + (activeTab === 'team' ? ' active' : '')"
      >
        🏐 Team Statistics
      </button>
      <button
        (click)="activeTab = 'players'"
        [class]="'main-tab' + (activeTab === 'players' ? ' active' : '')"
      >
        👤 Individual Players
      </button>
      <button
        (click)="activeTab = 'allPlayers'; loadAllPlayersStats()"
        [class]="'main-tab' + (activeTab === 'allPlayers' ? ' active' : '')"
      >
        👥 All Players Comparison
      </button>
    </div>

    <!-- ========== TEAM STATISTICS TAB ========== -->
    <div *ngIf="activeTab === 'team'" class="tab-panel">
      <div class="tab-header">
        <div class="tab-title">
          <h3>{{ team?.name || 'Team' }} Statistics</h3>
          <p>View and analyze team performance metrics</p>
        </div>
        <div class="tab-controls">
          <button 
            (click)="showBasicFilters = true"
            class="filter-btn"
            title="Open Team Filters"
          >
            🔍 Team Filters
          </button>
        </div>
      </div>

      <!-- Team Sub-tabs -->
      <div class="sub-tabs">
        <button 
          (click)="teamViewMode = 'table'"
          [class]="'sub-tab' + (teamViewMode === 'table' ? ' active' : '')"
        >
          📋 Table View
        </button>
        <button 
          (click)="teamViewMode = 'events'"
          [class]="'sub-tab' + (teamViewMode === 'events' ? ' active' : '')"
        >
          📅 Events View
        </button>
      </div>

      <!-- Team Content -->
      <div class="tab-content-area">
        <div *ngIf="teamStatistics.length === 0" class="empty-state">
          <div class="empty-icon">📊</div>
          <h4>No team statistics found</h4>
          <p>Add some statistics or adjust your filters to see data.</p>
        </div>

        <!-- Team Table View -->
        <div *ngIf="teamStatistics.length > 0 && teamViewMode === 'table'" class="table-view">
          <div class="table-container">
            <table class="stats-table">
              <thead>
                <tr>
                  <th (click)="sortBy('stat_date')" class="sortable">
                    Date
                    <span class="sort-indicator" *ngIf="sortField === 'stat_date'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th (click)="sortBy('stat_category')" class="sortable">
                    Category
                    <span class="sort-indicator" *ngIf="sortField === 'stat_category'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th (click)="sortBy('stat_name')" class="sortable">
                    Statistic
                    <span class="sort-indicator" *ngIf="sortField === 'stat_name'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th (click)="sortBy('stat_value')" class="sortable">
                    Value
                    <span class="sort-indicator" *ngIf="sortField === 'stat_value'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th (click)="sortBy('game_type')" class="sortable">
                    Game Type
                    <span class="sort-indicator" *ngIf="sortField === 'game_type'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th (click)="sortBy('opponent')" class="sortable">
                    Opponent
                    <span class="sort-indicator" *ngIf="sortField === 'opponent'">
                      {{ sortDirection === 'asc' ? '↑' : '↓' }}
                    </span>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stat of teamStatistics">
                  <td>{{ stat.stat_date | date:'shortDate' }}</td>
                  <td>
                    <span class="category-badge">{{ getCategoryLabel(stat.stat_category) }}</span>
                  </td>
                  <td>{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</td>
                  <td class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</td>
                  <td>
                    <span class="game-type-badge">{{ stat.game_type }}</span>
                  </td>
                  <td>{{ stat.opponent || '-' }}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                      <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Team Events View -->
        <div *ngIf="teamStatistics.length > 0 && teamViewMode === 'events'" class="events-view">
          <div class="events-container">
            <div *ngFor="let eventGroup of getStatsByEvent(teamStatistics)" class="event-group">
              <div class="event-header">
                <div class="event-info">
                  <h4>{{ eventGroup.eventName }}</h4>
                  <div class="event-meta">
                    <span class="event-date">📅 {{ eventGroup.date | date:'fullDate' }}</span>
                    <span class="event-type">🏐 {{ eventGroup.gameType }}</span>
                    <span class="event-opponent" *ngIf="eventGroup.opponent">🆚 {{ eventGroup.opponent }}</span>
                  </div>
                </div>
                <div class="event-stats-count">
                  {{ eventGroup.stats.length }} stats
                </div>
              </div>
              <div class="event-stats-grid">
                <div *ngFor="let stat of eventGroup.stats" class="event-stat-card">
                  <div class="stat-category">{{ getCategoryLabel(stat.stat_category) }}</div>
                  <div class="stat-name">{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</div>
                  <div class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</div>
                  <div class="stat-actions">
                    <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                    <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== INDIVIDUAL PLAYERS TAB ========== -->
    <div *ngIf="activeTab === 'players'" class="tab-panel">
      <div class="tab-header">
        <div class="tab-title">
          <h3>Individual Player Statistics</h3>
          <p>Select a player to view their detailed performance</p>
        </div>
        <div class="tab-controls">
          <button 
            (click)="showBasicFilters = true"
            class="filter-btn"
            title="Open Player Filters"
          >
            🔍 Player Filters
          </button>
        </div>
      </div>

      <!-- Player Selection -->
      <div class="player-selection-section">
        <div class="form-group">
          <label for="playerSelect">Select Player:</label>
          <select 
            id="playerSelect"
            [(ngModel)]="selectedPlayerId" 
            (ngModelChange)="selectedPlayerId && onPlayerSelect(selectedPlayerId)"
            class="form-control"
          >
            <option value="">Choose a player...</option>
            <option *ngFor="let player of players" [value]="player.id">
              {{ getPlayerFullName(player) }}
            </option>
          </select>
        </div>
      </div>

      <!-- Player Sub-tabs -->
      <div class="sub-tabs" *ngIf="selectedPlayerId">
        <button 
          (click)="playerViewMode = 'table'"
          [class]="'sub-tab' + (playerViewMode === 'table' ? ' active' : '')"
        >
          📋 Table View
        </button>
        <button 
          (click)="playerViewMode = 'events'"
          [class]="'sub-tab' + (playerViewMode === 'events' ? ' active' : '')"
        >
          📅 Events View
        </button>
      </div>

      <!-- Player Content -->
      <div class="tab-content-area" *ngIf="selectedPlayerId">
        <div *ngIf="selectedPlayerSummary.length > 0" class="player-summary-section">
          <h4>Performance Summary</h4>
          <div class="summary-grid">
            <div *ngFor="let summary of selectedPlayerSummary" class="summary-card">
              <div class="summary-label">{{ summary.stat_name || summary.statName }}</div>
              <div class="summary-value">{{ summary.total_value || summary.totalValue }}</div>
            </div>
          </div>
        </div>

        <div *ngIf="playerStatistics.length === 0" class="empty-state">
          <div class="empty-icon">👤</div>
          <h4>No statistics found for this player</h4>
          <p>Add some statistics or adjust your filters to see data.</p>
        </div>

        <!-- Player Table View -->
        <div *ngIf="playerStatistics.length > 0 && playerViewMode === 'table'" class="table-view">
          <div class="table-container">
            <table class="stats-table">
              <thead>
                <tr>
                  <th (click)="sortBy('stat_date')" class="sortable">Date</th>
                  <th (click)="sortBy('stat_category')" class="sortable">Category</th>
                  <th (click)="sortBy('stat_name')" class="sortable">Statistic</th>
                  <th (click)="sortBy('stat_value')" class="sortable">Value</th>
                  <th (click)="sortBy('game_type')" class="sortable">Game Type</th>
                  <th (click)="sortBy('opponent')" class="sortable">Opponent</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stat of playerStatistics">
                  <td>{{ stat.stat_date | date:'shortDate' }}</td>
                  <td>
                    <span class="category-badge">{{ getCategoryLabel(stat.stat_category) }}</span>
                  </td>
                  <td>{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</td>
                  <td class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</td>
                  <td>
                    <span class="game-type-badge">{{ stat.game_type }}</span>
                  </td>
                  <td>{{ stat.opponent || '-' }}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                      <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Player Events View -->
        <div *ngIf="playerStatistics.length > 0 && playerViewMode === 'events'" class="events-view">
          <div class="events-container">
            <div *ngFor="let eventGroup of getStatsByEvent(playerStatistics)" class="event-group">
              <div class="event-header">
                <div class="event-info">
                  <h4>{{ eventGroup.eventName }}</h4>
                  <div class="event-meta">
                    <span class="event-date">📅 {{ eventGroup.date | date:'fullDate' }}</span>
                    <span class="event-type">🏐 {{ eventGroup.gameType }}</span>
                    <span class="event-opponent" *ngIf="eventGroup.opponent">🆚 {{ eventGroup.opponent }}</span>
                  </div>
                </div>
                <div class="event-stats-count">
                  {{ eventGroup.stats.length }} stats
                </div>
              </div>
              <div class="event-stats-grid">
                <div *ngFor="let stat of eventGroup.stats" class="event-stat-card">
                  <div class="stat-category">{{ getCategoryLabel(stat.stat_category) }}</div>
                  <div class="stat-name">{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</div>
                  <div class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</div>
                  <div class="stat-actions">
                    <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                    <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== ALL PLAYERS COMPARISON TAB ========== -->
    <div *ngIf="activeTab === 'allPlayers'" class="tab-panel">
      <div class="tab-header">
        <div class="tab-title">
          <h3>All Players Comparison</h3>
          <p>Compare statistics across all team players</p>
        </div>
        <div class="tab-controls">
          <button 
            (click)="showAdvancedFilters = true"
            class="filter-btn advanced"
            title="Open Advanced Filters"
          >
            🔧 Advanced Filters
          </button>
        </div>
      </div>

      <!-- All Players Sub-tabs -->
      <div class="sub-tabs">
        <button 
          (click)="allPlayersViewMode = 'table'"
          [class]="'sub-tab' + (allPlayersViewMode === 'table' ? ' active' : '')"
        >
          📋 Table View
        </button>
        <button 
          (click)="allPlayersViewMode = 'events'"
          [class]="'sub-tab' + (allPlayersViewMode === 'events' ? ' active' : '')"
        >
          📅 Events View
        </button>
      </div>

      <!-- All Players Content -->
      <div class="tab-content-area">
        <div *ngIf="allPlayersStatistics.length === 0" class="empty-state">
          <div class="empty-icon">👥</div>
          <h4>No player statistics found</h4>
          <p>Add some statistics or adjust your filters to see data.</p>
        </div>

        <!-- All Players Table View -->
        <div *ngIf="allPlayersStatistics.length > 0 && allPlayersViewMode === 'table'" class="table-view">
          <div class="table-container">
            <table class="stats-table">
              <thead>
                <tr>
                  <th (click)="sortBy('player_name')" class="sortable">Player</th>
                  <th (click)="sortBy('stat_date')" class="sortable">Date</th>
                  <th (click)="sortBy('stat_category')" class="sortable">Category</th>
                  <th (click)="sortBy('stat_name')" class="sortable">Statistic</th>
                  <th (click)="sortBy('stat_value')" class="sortable">Value</th>
                  <th (click)="sortBy('game_type')" class="sortable">Game Type</th>
                  <th (click)="sortBy('opponent')" class="sortable">Opponent</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let stat of allPlayersStatistics">
                  <td>
                    <span class="player-name">{{ stat.player_name }}</span>
                  </td>
                  <td>{{ stat.stat_date | date:'shortDate' }}</td>
                  <td>
                    <span class="category-badge">{{ getCategoryLabel(stat.stat_category) }}</span>
                  </td>
                  <td>{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</td>
                  <td class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</td>
                  <td>
                    <span class="game-type-badge">{{ stat.game_type }}</span>
                  </td>
                  <td>{{ stat.opponent || '-' }}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                      <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- All Players Events View -->
        <div *ngIf="allPlayersStatistics.length > 0 && allPlayersViewMode === 'events'" class="events-view">
          <div class="events-container">
            <div *ngFor="let eventGroup of getStatsByEvent(allPlayersStatistics)" class="event-group">
              <div class="event-header">
                <div class="event-info">
                  <h4>{{ eventGroup.eventName }}</h4>
                  <div class="event-meta">
                    <span class="event-date">📅 {{ eventGroup.date | date:'fullDate' }}</span>
                    <span class="event-type">🏐 {{ eventGroup.gameType }}</span>
                    <span class="event-opponent" *ngIf="eventGroup.opponent">🆚 {{ eventGroup.opponent }}</span>
                  </div>
                </div>
                <div class="event-stats-count">
                  {{ eventGroup.stats.length }} stats
                </div>
              </div>
              <div class="event-stats-grid">
                <div *ngFor="let stat of eventGroup.stats" class="event-stat-card">
                  <div class="stat-player">{{ stat.player_name }}</div>
                  <div class="stat-category">{{ getCategoryLabel(stat.stat_category) }}</div>
                  <div class="stat-name">{{ getStatDisplayName(stat.stat_name, stat.stat_category) }}</div>
                  <div class="stat-value">{{ formatStatValue(stat.stat_value, stat.stat_name) }}</div>
                  <div class="stat-actions">
                    <button class="action-btn edit" (click)="editStat(stat)" title="Edit">✏️</button>
                    <button class="action-btn delete" (click)="deleteStat(stat)" title="Delete">🗑️</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ========== FILTER MODALS ========== -->

  <!-- Basic Filters Modal -->
  <div 
    class="modal-overlay" 
    *ngIf="showBasicFilters"
    (click)="showBasicFilters = false"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>🔍 Filters</h3>
        <button 
          class="modal-close" 
          (click)="showBasicFilters = false"
        >
          ✕
        </button>
      </div>
      
      <div class="modal-body">
        <div class="filter-grid">
          <div class="filter-group">
            <label>Start Date</label>
            <input 
              type="date" 
              [(ngModel)]="basicFilters.startDate"
              (ngModelChange)="applyBasicFilters()"
              class="form-control"
            />
          </div>
          
          <div class="filter-group">
            <label>End Date</label>
            <input 
              type="date" 
              [(ngModel)]="basicFilters.endDate"
              (ngModelChange)="applyBasicFilters()"
              class="form-control"
            />
          </div>
          
          <div class="filter-group">
            <label>Game Type</label>
            <select 
              [(ngModel)]="basicFilters.gameType"
              (ngModelChange)="applyBasicFilters()"
              class="form-control"
            >
              <option value="">All Types</option>
              <option value="practice">Practice</option>
              <option value="scrimmage">Scrimmage</option>
              <option value="game">Game</option>
              <option value="tournament">Tournament</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button 
          class="btn btn-secondary" 
          (click)="clearBasicFilters()"
        >
          Clear Filters
        </button>
        <button 
          class="btn btn-primary" 
          (click)="showBasicFilters = false"
        >
          Apply Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Advanced Filters Modal -->
  <div 
    class="modal-overlay" 
    *ngIf="showAdvancedFilters"
    (click)="showAdvancedFilters = false"
  >
    <div class="modal-content advanced" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>🔧 Advanced Filters</h3>
        <button 
          class="modal-close" 
          (click)="showAdvancedFilters = false"
        >
          ✕
        </button>
      </div>
      
      <div class="modal-body">
        <div class="filter-grid advanced">
          <div class="filter-group">
            <label>Player</label>
            <select 
              [(ngModel)]="advancedFilters.player"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            >
              <option value="">All Players</option>
              <option *ngFor="let player of players" [value]="player.id">
                {{ getPlayerFullName(player) }}
              </option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Category</label>
            <select 
              [(ngModel)]="advancedFilters.category"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            >
              <option value="">All Categories</option>
              <option *ngFor="let category of categories" [value]="category.name">
                {{ category.label }}
              </option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Game Type</label>
            <select 
              [(ngModel)]="advancedFilters.gameType"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            >
              <option value="">All Types</option>
              <option value="practice">Practice</option>
              <option value="scrimmage">Scrimmage</option>
              <option value="game">Game</option>
              <option value="tournament">Tournament</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Event</label>
            <select 
              [(ngModel)]="advancedFilters.event"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            >
              <option value="">All Events</option>
              <option *ngFor="let event of events" [value]="event.id">
                {{ event.name }} - {{ event.date | date:'shortDate' }}
              </option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>Start Date</label>
            <input 
              type="date" 
              [(ngModel)]="advancedFilters.startDate"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            />
          </div>
          
          <div class="filter-group">
            <label>End Date</label>
            <input 
              type="date" 
              [(ngModel)]="advancedFilters.endDate"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
            />
          </div>
          
          <div class="filter-group">
            <label>Min Value</label>
            <input 
              type="number" 
              step="0.001"
              [(ngModel)]="advancedFilters.minValue"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
              placeholder="Minimum value"
            />
          </div>
          
          <div class="filter-group">
            <label>Max Value</label>
            <input 
              type="number" 
              step="0.001"
              [(ngModel)]="advancedFilters.maxValue"
              (ngModelChange)="applyAdvancedFilters()"
              class="form-control"
              placeholder="Maximum value"
            />
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button 
          class="btn btn-secondary" 
          (click)="clearAdvancedFilters()"
        >
          Clear All Filters
        </button>
        <button 
          class="btn btn-primary" 
          (click)="showAdvancedFilters = false"
        >
          Apply Filters
        </button>
      </div>
    </div>
  </div>

</div>
